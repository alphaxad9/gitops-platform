# gitops-platform/infrastructure/overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: infrastructure

resources:
  - ../../base  # ✅ This brings in your existing secrets & configmaps

labels:
  - pairs:
      environment: dev
      managed-by: gitops
    includeSelectors: false

# ✅ FIX: Use patches (not configMapGenerator) for static base ConfigMaps
patches:
  - target:
      kind: ConfigMap
      name: platform-endpoints
    patch: |
      - op: add
        path: /data/ENVIRONMENT
        value: dev
      - op: add
        path: /data/LOG_LEVEL
        value: DEBUG

# ✅ FIX: Separate valuesFile per chart (point to split files below)
helmCharts:
  - name: postgresql
    repo: https://charts.bitnami.com/bitnami
    version: "12.1.2"
    releaseName: postgresql
    valuesFile: values-postgresql.yaml

  - name: kafka
    repo: https://charts.bitnami.com/bitnami
    version: "22.1.4"
    releaseName: kafka
    valuesFile: values-kafka.yaml

  - name: redis
    repo: https://charts.bitnami.com/bitnami
    version: "17.11.3"
    releaseName: redis
    valuesFile: values-redis.yaml

  - name: rabbitmq
    repo: https://charts.bitnami.com/bitnami
    version: "12.5.2"
    releaseName: rabbitmq
    valuesFile: values-rabbitmq.yaml

  - name: traefik
    repo: https://helm.traefik.io/traefik
    version: "25.0.0"
    releaseName: traefik
    valuesFile: values-traefik.yaml