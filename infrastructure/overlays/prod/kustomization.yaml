# gitops-platform/infrastructure/overlays/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: infrastructure

resources:
  - ../../base  # ✅ Brings in your existing secrets & configmaps

labels:
  - pairs:
      environment: prod
      managed-by: gitops
      criticality: high
    includeSelectors: false

# ✅ Use patches for static base ConfigMaps
patches:
  - target:
      kind: ConfigMap
      name: platform-endpoints
    patch: |
      - op: add
        path: /data/ENVIRONMENT
        value: prod
      - op: add
        path: /data/LOG_LEVEL
        value: WARNING
      - op: add
        path: /data/BACKUP_ENABLED
        value: "true"

# ✅ Separate valuesFile per chart + valid semver versions
helmCharts:
  - name: postgresql
    repo: https://charts.bitnami.com/bitnami
    version: "12.1.2"
    releaseName: postgresql
    valuesFile: values-postgresql.yaml

  - name: kafka
    repo: https://charts.bitnami.com/bitnami
    version: "22.1.4"
    releaseName: kafka
    valuesFile: values-kafka.yaml

  - name: redis
    repo: https://charts.bitnami.com/bitnami
    version: "17.11.3"
    releaseName: redis
    valuesFile: values-redis.yaml

  - name: rabbitmq
    repo: https://charts.bitnami.com/bitnami
    version: "12.5.2"
    releaseName: rabbitmq
    valuesFile: values-rabbitmq.yaml

  - name: traefik
    repo: https://helm.traefik.io/traefik
    version: "25.0.0"
    releaseName: traefik
    valuesFile: values-traefik.yaml