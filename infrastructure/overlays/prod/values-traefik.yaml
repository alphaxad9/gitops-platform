# gitops-platform/infrastructure/overlays/prod/values-traefik.yaml
# Production config: TLS, security headers, monitoring

deployment:
  replicas: 2  # âœ… HA: multiple Traefik pods
  podDisruptionBudget:
    enabled: true
    minAvailable: 1

image:
  name: traefik
  tag: v2.11
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"  # âœ… Example for AWS
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:..."  # âœ… ACM cert

logs:
  general:
    level: WARN  # âœ… Less verbose in prod
  access:
    enabled: true
    format: json  # âœ… Structured logs for ingestion

# âœ… Disable insecure dashboard in prod
ingressRoute:
  dashboard:
    enabled: false  # ðŸ”’ Disable by default; enable via separate secure ingress if needed

additionalArguments:
  - "--providers.kubernetescrd.namespaces=auth-service,payment-service,infrastructure"
  - "--accesslog=true"
  - "--accesslog.format=json"
  - "--metrics.prometheus=true"
  - "--metrics.prometheus.entryPoint=metrics"
  - "--entryPoints.metrics.address=:9100"
  - "--serverstransport.insecureskipverify=false"  # âœ… Verify backend TLS

ports:
  web:
    port: 80
    expose: true
    redirectTo:
      port: websecure  # âœ… Force HTTPS
  websecure:
    port: 443
    expose: true
    tls:
      enabled: true
      options: "default"  # âœ… Use TLSOptions CRD for strong ciphers

# âœ… TLS configuration via cert-manager
tlsOptions:
  default:
    minVersion: VersionTLS12
    cipherSuites:
      - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
      - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384

# âœ… Monitoring
metrics:
  prometheus:
    entryPoint: metrics

# âœ… Security headers via Middleware CRDs (define separately)
# Example: add middleware reference in IngressRoute for HSTS, CSP, etc.