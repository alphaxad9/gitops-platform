# gitops-platform/infrastructure/overlays/prod/values-kafka.yaml
# Production config: HA, persistence, monitoring, Bitnami image

replicaCount: 3  # HA: 3 brokers for fault tolerance

kraft:
  enabled: true
  controllerQuorumVoters: "0@kafka-0.kafka-headless.infrastructure.svc.cluster.local:9093,1@kafka-1.kafka-headless.infrastructure.svc.cluster.local:9093,2@kafka-2.kafka-headless.infrastructure.svc.cluster.local:9093"

listeners:
  client:
    protocol: SASL_SSL  # Production: encrypted + authenticated
    containerPort: 9092
  controller:
    protocol: PLAINTEXT  # Internal controller comm on private network
    containerPort: 9093
  interbroker:
    protocol: SASL_PLAINTEXT
    containerPort: 9094

persistence:
  enabled: true
  size: 100Gi
  storageClass: "gp3"  # Use your production storage class

resources:
  requests:
    memory: 4Gi
    cpu: 2000m
  limits:
    memory: 8Gi
    cpu: 4000m

# ✅ Production: enable TLS
tls:
  enabled: true
  autoGenerated: false
  existingSecret: "kafka-tls-cert"  # Manage via cert-manager or external secret

# ✅ SASL/SCRAM auth via existing secret
auth:
  clientProtocol: sasl_ssl
  interBrokerProtocol: sasl_plaintext
  existingSecret: kafka-credentials
  existingSecretPasswordKey: KAFKA_PASSWORD
  clientUsers:
    - auth-service
    - payment-service
  clientPasswords: []  # Let chart generate or use external secret

# ✅ Auto-create topics disabled in prod (manage via IaC)
autoCreateTopicsEnable: false

logLevel: WARN

# ✅ Monitoring & metrics
metrics:
  enabled: true
  kafka:
    enabled: true
  jmx:
    enabled: true
  serviceMonitor:
    enabled: true

# ✅ Log retention for compliance
config:
  log:
    retention:
      hours: 168  # 7 days
  offset:
    retention:
      minutes: 10080  # 7 days

# ✅ Pod disruption budget for HA
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# ✅ Anti-affinity to spread across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: kafka
          topologyKey: kubernetes.io/hostname