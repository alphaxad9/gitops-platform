# gitops-platform/infrastructure/overlays/prod/values-postgresql.yaml
# Production config: HA, persistence, backups, TLS

global:
  postgresql:
    auth:
      existingSecret: postgres-credentials

auth:
  existingSecret: postgres-credentials
  secretKeys:
    userPasswordKey: POSTGRES_PASSWORD
    adminPasswordKey: POSTGRES_PASSWORD

architecture: replication  # ✅ HA: primary + read replicas

primary:
  persistence:
    enabled: true
    size: 50Gi
    storageClass: "gp3"  # ✅ Use your prod storage class
  resources:
    requests:
      memory: 2Gi
      cpu: 1000m
    limits:
      memory: 4Gi
      cpu: 2000m
  podAffinityPreset: anti  # ✅ Spread replicas across nodes

readReplicas:
  replicaCount: 2  # ✅ 2 read replicas for scale
  persistence:
    enabled: true
    size: 50Gi
  resources:
    requests:
      memory: 1Gi
      cpu: 500m
    limits:
      memory: 2Gi
      cpu: 1000m

initdbScripts:
  create-databases.sql: |
    CREATE DATABASE authdb;
    CREATE DATABASE paymentdb;

# ✅ Production: enable TLS
tls:
  enabled: true
  autoGenerated: false
  certificatesSecret: "postgres-tls-cert"  # ✅ Manage via cert-manager or external secret

# ✅ Backups via pgBackRest (or integrate with Velero)
backup:
  enabled: true
  cronJob:
    schedule: "0 2 * * *"  # Daily at 2 AM UTC
    retention: "7d"

# ✅ Monitoring
metrics:
  enabled: true
  serviceMonitor:
    enabled: true