apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: auth-service

resources:
  - ../../base/service-template
  - auth-secrets.yaml
  - auth-sa.yaml
  - postgres-credentials.yaml
  - rabbitmq-credentials.yaml  
  - kafka-credentials.yaml      
  - redis-credentials.yaml   

configMapGenerator:
  - name: auth-config
    literals:
      - SERVICE_NAME=auth
      - DB_NAME=authdb
      - DJANGO_SETTINGS_MODULE=my_backend.settings
      - KAFKA_GROUP_ID=my_backend_id
      - AUTH_PUBLIC_KEY_URL=http://auth-service.auth-service.svc.cluster.local:8000/zedvye_one/users/public_key/
      - LOG_LEVEL=INFO
      - RABBITMQ_QUEUE=microservice_one.events
      - RABBITMQ_VHOST=microservice_one     
      - KAFKA_TOPIC=microservice_one.events

images:
  - name: placeholder
    newName: alphaxad9/auth-service
    newTag: "0.0.1"

patches:
  # Patch postgres-credentials with auth-specific values
  - target:
      kind: Secret
      name: postgres-credentials
    patch: |-
      - op: replace
        path: /stringData/DB_NAME
        value: authdb
      - op: replace
        path: /stringData/DB_USER
        value: ishimwe
      - op: replace
        path: /stringData/DB_PASSWORD
        value: "2025New+"

  # Patch deployment name and all references
  - target:
      kind: Deployment
      name: service-placeholder
    patch: |-
      - op: replace
        path: /metadata/name
        value: auth-service
      - op: replace
        path: /metadata/labels/app
        value: auth-service
      - op: replace
        path: /metadata/labels/service
        value: auth-service
      - op: replace
        path: /spec/selector/matchLabels/app
        value: auth-service
      - op: replace
        path: /spec/template/metadata/labels/app
        value: auth-service
      - op: replace
        path: /spec/template/metadata/labels/service
        value: auth-service
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: auth-service-sa
      - op: replace
        path: /spec/template/spec/containers/0/name
        value: auth-service
      - op: replace
        path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
        value: auth-config
      - op: replace
        path: /spec/template/spec/containers/0/envFrom/1/secretRef/name
        value: auth-secrets

  # ADD keys volume and volumeMount for auth-service ONLY
  - target:
      kind: Deployment
      name: auth-service
    patch: |-
      # Add volumeMount for keys
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: keys
          mountPath: /app/keys
          readOnly: true
      # Add volume for keys
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: keys
          secret:
            secretName: auth-secrets
            items:
            - key: SIGNING_KEY
              path: private.pem

  # Patch service name and labels
  - target:
      kind: Service
      name: service-placeholder-service
    patch: |-
      - op: replace
        path: /metadata/name
        value: auth-service
      - op: replace
        path: /metadata/labels/app
        value: auth-service
      - op: replace
        path: /spec/selector/app
        value: auth-service

  # Patch PVC names
  - target:
      kind: PersistentVolumeClaim
      name: service-placeholder-static-pvc
    patch: |-
      - op: replace
        path: /metadata/name
        value: auth-service-static-pvc
  - target:
      kind: PersistentVolumeClaim
      name: service-placeholder-media-pvc
    patch: |-
      - op: replace
        path: /metadata/name
        value: auth-service-media-pvc