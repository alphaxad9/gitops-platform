# gitops-platform/services/payment-service/base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: payment-service

resources:
  - ../../base/service-template
  - payment-secrets.yaml
  - payment-sa.yaml
  - postgres-credentials.yaml

configMapGenerator:
  - name: payment-config
    literals:
      - SERVICE_NAME=payment
      - DB_NAME=paymentdb
      - DJANGO_SETTINGS_MODULE=payment_service.settings
      - AUTH_SERVICE_URL=http://auth-service.auth-service.svc.cluster.local:8000/zedvye_one/
      - AUTH_PUBLIC_KEY_URL=http://auth-service.auth-service.svc.cluster.local:8000/zedvye_one/users/public_key/
      - LOG_LEVEL=INFO
      - RABBITMQ_QUEUE=microservice_one.events
      - RABBITMQ_VHOST=microservice_one     
      - KAFKA_TOPIC=microservice_one.events

images:
  - name: placeholder
    newName: alphaxad9/payment-service
    newTag: "0.0.1"

patches:
  # Patch postgres-credentials with payment-specific values
  - target:
      kind: Secret
      name: postgres-credentials
    patch: |-
      - op: replace
        path: /stringData/DB_NAME
        value: paymentdb
      - op: replace
        path: /stringData/DB_USER
        value: ishimwe
      - op: replace
        path: /stringData/DB_PASSWORD
        value: "2025New+"

  # Patch deployment name and all references
  - target:
      kind: Deployment
      name: service-placeholder
    patch: |-
      - op: replace
        path: /metadata/name
        value: payment-service
      - op: replace
        path: /metadata/labels/app
        value: payment-service
      - op: replace
        path: /metadata/labels/service
        value: payment-service
      - op: replace
        path: /spec/selector/matchLabels/app
        value: payment-service
      - op: replace
        path: /spec/template/metadata/labels/app
        value: payment-service
      - op: replace
        path: /spec/template/metadata/labels/service
        value: payment-service
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: payment-service-sa
      - op: replace
        path: /spec/template/spec/containers/0/name
        value: payment-service
      - op: replace
        path: /spec/template/spec/containers/0/envFrom/0/configMapRef/name
        value: payment-config
      - op: replace
        path: /spec/template/spec/containers/0/envFrom/1/secretRef/name
        value: payment-secrets

  # REMOVE the keys volume and volumeMount for payment-service (UPDATED with descriptive comments)
  - target:
      kind: Deployment
      name: payment-service
    patch: |-
      # Remove volumeMount that mounts to /app/keys (index may need adjustment)
      - op: remove
        path: /spec/template/spec/containers/0/volumeMounts/2
      # Remove volume that references payment-secrets for keys
      - op: remove
        path: /spec/template/spec/volumes/2

  # Patch service name and labels
  - target:
      kind: Service
      name: service-placeholder-service
    patch: |-
      - op: replace
        path: /metadata/name
        value: payment-service
      - op: replace
        path: /metadata/labels/app
        value: payment-service
      - op: replace
        path: /spec/selector/app
        value: payment-service

  # Patch PVC names
  - target:
      kind: PersistentVolumeClaim
      name: service-placeholder-static-pvc
    patch: |-
      - op: replace
        path: /metadata/name
        value: payment-service-static-pvc
  - target:
      kind: PersistentVolumeClaim
      name: service-placeholder-media-pvc
    patch: |-
      - op: replace
        path: /metadata/name
        value: payment-service-media-pvc