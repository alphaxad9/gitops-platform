# gitops-platform/environments/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - infrastructure-application.yaml
  - auth-application.yaml
  - payment-application.yaml

labels:
  - pairs:
      environment: prod
      managed-by: gitops
      app.kubernetes.io/managed-by: argocd
      app.kubernetes.io/part-of: microservices-platform
      app.kubernetes.io/environment: production
    includeSelectors: false
commonAnnotations:
  description: "Production environment for microservices (LIVE TRAFFIC)"
  team: "platform-team"
  contact: "oncall@example.com"
  pagerduty: "https://example.pagerduty.com"
  stability: "production"
  criticality: "high"
  sla: "99.95"

namespace: argocd

configMapGenerator:
  - name: environment-config
    literals:
      - ENVIRONMENT=prod
      - REPO_URL=https://github.com/alphaxad9/gitops-platform.git
      - TARGET_REVISION=main  # Production uses main branch only
      - DEPLOYMENT_STRATEGY=rolling-update
      - ROLLBACK_STRATEGY=auto

patches:
  # Add production-specific annotations to all applications
  - target:
      kind: Application
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: Prune=true
          argocd.argoproj.io/managed-by: argocd
          argocd.argoproj.io/manual-sync: disabled  # Optional: Require manual approval
      - op: replace
        path: /spec/source/repoURL
        value: https://github.com/alphaxad9/gitops-platform.git
      - op: replace
        path: /spec/source/targetRevision
        value: main  # Production always deploys from main branch
      - op: add
        path: /spec/syncPolicy/automated
        value:
          prune: true
          selfHeal: true
          allowEmpty: false
          
  # Add wave ordering for production (deploy infrastructure first)
  - target:
      kind: Application
      name: infrastructure
    patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io/sync-wave
        value: "-5"
        
  - target:
      kind: Application
      name: auth-service
    patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io/sync-wave
        value: "0"
        
  - target:
      kind: Application
      name: payment-service
    patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io/sync-wave
        value: "5"