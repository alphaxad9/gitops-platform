# gitops-platform/environments/staging/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - infrastructure-application.yaml
  - auth-application.yaml
  - payment-application.yaml

labels:
  - pairs:
      environment: staging
      managed-by: gitops
      app.kubernetes.io/managed-by: argocd
      app.kubernetes.io/part-of: microservices-platform
    includeSelectors: false
commonAnnotations:
  description: "Staging environment for microservices (pre-production)"
  team: "platform-team"
  contact: "platform@example.com"
  stability: "pre-production"

namespace: argocd

configMapGenerator:
  - name: environment-config
    literals:
      - ENVIRONMENT=staging
      - REPO_URL=https://github.com/alphaxad9/gitops-platform.git
      - TARGET_REVISION=staging  # Could use a staging branch or main

patches:
  # Add common annotations to all applications
  - target:
      kind: Application
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-options: Prune=true
          argocd.argoproj.io/managed-by: argocd
      - op: replace
        path: /spec/source/repoURL
        value: https://github.com/alphaxad9/gitops-platform.git
      - op: replace
        path: /spec/source/targetRevision
        value: staging  # Using staging branch for more controlled deployments
  
  # Optional: Add staging-specific sync windows or other policies
  - target:
      kind: Application
    patch: |-
      - op: add
        path: /spec/syncPolicy/retry
        value:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 5m